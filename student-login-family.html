<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Login - BedrockELA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #5B7C99 0%, #305853 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 550px;
            width: 100%;
            padding: 50px 40px;
            transition: all 0.3s ease;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .logo h2 {
            font-size: 1.8rem;
            color: #305853;
            margin-bottom: 10px;
        }
        
        .logo p {
            color: #666;
            font-size: 1.1rem;
        }
        
        /* STEP 1: Family Login */
        #step1 {
            display: block;
        }
        
        #step2 {
            display: none;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 700;
            color: #305853;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        input {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.2rem;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        input:focus {
            outline: none;
            border-color: #5B7C99;
        }
        
        input[type="password"] {
            font-size: 1.5rem;
            letter-spacing: 5px;
        }
        
        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #5B7C99 0%, #305853 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(91, 124, 153, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none;
            text-align: center;
            font-size: 1rem;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        /* STEP 2: Student Selection */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .student-card {
            background: linear-gradient(135deg, #F5EFE7 0%, #FFF 100%);
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            border-color: #5B7C99;
            box-shadow: 0 10px 25px rgba(91, 124, 153, 0.2);
        }
        
        .student-icon {
            font-size: 4rem;
            margin-bottom: 10px;
        }
        
        .student-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #305853;
            margin-bottom: 5px;
        }
        
        .student-grade {
            font-size: 0.9rem;
            color: #666;
        }
        
        .back-btn {
            background: transparent;
            color: #5B7C99;
            border: 2px solid #5B7C99;
            margin-top: 20px;
        }
        
        .back-btn:hover {
            background: #5B7C99;
            color: white;
        }
        
        .family-name-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #F5F9FF;
            border-radius: 15px;
        }
        
        .family-name-display h3 {
            color: #5B7C99;
            font-size: 1.3rem;
        }
        
        .back-link {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .back-link a {
            color: #5B7C99;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
        
        /* Mobile Responsive */
        @media (max-width: 480px) {
            .login-container {
                padding: 40px 25px;
            }
            
            .logo h1 {
                font-size: 2.5rem;
            }
            
            .logo h2 {
                font-size: 1.5rem;
            }
            
            .students-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .student-card {
                padding: 20px 10px;
            }
            
            .student-icon {
                font-size: 3rem;
            }
            
            .student-name {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="back-link">
            <a href="index.html">‚Üê Back to Home</a>
        </div>
        
        <!-- STEP 1: Family Login -->
        <div id="step1">
            <div class="logo">
                <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</h1>
                <h2>Family Login</h2>
                <p>Enter your family name and password</p>
            </div>
            
            <div id="message" class="message"></div>
            
            <form id="familyLoginForm">
                <div class="form-group">
                    <label for="familyName">Family Name</label>
                    <input type="text" id="familyName" name="familyName" required 
                           placeholder="Johnson" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="familyPassword">Family Password</label>
                    <input type="password" id="familyPassword" name="familyPassword" required 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
                </div>
                
                <button type="submit" class="btn-primary" id="familySubmitBtn">
                    Continue ‚Üí
                </button>
            </form>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="createFamilyBtn" class="btn-secondary" style="background: transparent; color: #5B7C99; border: 2px solid #5B7C99; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    Create New Family Account
                </button>
            </div>
        </div>
        
        <!-- STEP 2: Student Selection -->
        <div id="step2">
            <div class="logo">
                <h1>üìö</h1>
                <h2>Choose Your Student</h2>
                <p>Click your student to start learning!</p>
            </div>
            
            <div class="family-name-display" id="familyNameDisplay">
                <h3 id="displayFamilyName"></h3>
            </div>
            
            <div class="students-grid" id="studentsGrid">
                <!-- Students will be loaded here -->
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <a href="family-manage-students.html" style="color: #5B7C99; text-decoration: none; font-weight: 600;">
                    ‚ûï Add or Manage Students
                </a>
            </div>
            
            <button class="btn-primary back-btn" id="backToFamilyBtn">
                ‚Üê Back to Family Login
            </button>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:3001/api' 
            : 'https://bedrockela-website-production.up.railway.app/api';
        
        let currentFamily = null;
        
        // Student icons/emojis
        const studentIcons = ['üë¶', 'üëß', 'üßí', 'üë∂', 'üßë', 'üë®', 'üë©', 'üôã‚Äç‚ôÇÔ∏è', 'üôã‚Äç‚ôÄÔ∏è', 'üôã'];
        
        // STEP 1: Family Login
        document.getElementById('familyLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('familySubmitBtn');
            const message = document.getElementById('message');
            
            const familyName = document.getElementById('familyName').value.trim();
            const familyPassword = document.getElementById('familyPassword').value.trim();
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Checking...';
            
            try {
                const response = await fetch(`${API_URL}/family/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        family_name: familyName, 
                        password: familyPassword 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentFamily = data.family;
                    
                    // Save family data to sessionStorage for manage page
                    sessionStorage.setItem('bedrockela_family', JSON.stringify({
                        family: data.family,
                        students: data.students
                    }));
                    
                    // Show success
                    message.textContent = `Welcome, ${familyName} family! üéâ`;
                    message.className = 'message success';
                    message.style.display = 'block';
                    
                    // Load students after short delay
                    setTimeout(() => {
                        loadStudents(data.students);
                    }, 1000);
                } else {
                    // Show error with suggestion to create account
                    message.textContent = (data.error || 'Invalid family name or password') + ' - Click "Create New Family Account" below if you don\'t have one yet.';
                    message.className = 'message error';
                    message.style.display = 'block';
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Continue ‚Üí';
                }
            } catch (error) {
                console.error('Login error:', error);
                message.textContent = 'Network error. Please check your connection.';
                message.className = 'message error';
                message.style.display = 'block';
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Continue ‚Üí';
            }
        });
        
        // Load students into grid
        function loadStudents(students) {
            if (!students || students.length === 0) {
                document.getElementById('studentsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                        <p style="font-size: 1.2rem;">No students found. Add your first student!</p>
                        <button onclick="window.location.href='family-manage-students.html'" 
                                style="margin-top: 20px; padding: 15px 30px; background: linear-gradient(135deg, #5B7C99 0%, #2E4057 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
                            ‚ûï Add Students
                        </button>
                    </div>
                `;
            } else {
                document.getElementById('displayFamilyName').textContent = `${currentFamily.family_name} Family`;
                
                const grid = document.getElementById('studentsGrid');
                grid.innerHTML = students.map((student, index) => `
                    <div class="student-card" onclick="selectStudent(${student.id})">
                        <div class="student-icon">${student.avatar || studentIcons[index % studentIcons.length]}</div>
                        <div class="student-name">${student.name}</div>
                        <div class="student-grade">Grade ${student.grade_level}</div>
                    </div>
                `).join('');
            }
            
            // Show step 2
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }
        
        // Select student and go to dashboard
        window.selectStudent = async (studentId) => {
            try {
                // Get full student info
                const response = await fetch(`${API_URL}/student/${studentId}`);
                const data = await response.json();
                
                if (data.student) {
                    // Save student to localStorage
                    localStorage.setItem('bedrockela_student', JSON.stringify({
                        id: data.student.id,
                        name: data.student.name,
                        grade_level: data.student.grade_level,
                        current_lesson: data.student.current_lesson || 1,
                        family_id: currentFamily.id,
                        family_name: currentFamily.family_name
                    }));
                    
                    // Also save family data to sessionStorage for manage page
                    sessionStorage.setItem('bedrockela_family', JSON.stringify({
                        family: currentFamily,
                        students: Array.from(document.querySelectorAll('.student-card')).map(card => ({
                            id: parseInt(card.onclick.toString().match(/\d+/)[0]),
                            name: card.querySelector('.student-name').textContent,
                            grade_level: parseInt(card.querySelector('.student-grade').textContent)
                        }))
                    }));
                    
                    // Redirect to dashboard
                    window.location.href = 'student-dashboard-live.html';
                } else {
                    alert('Error loading student data');
                }
            } catch (error) {
                console.error('Error selecting student:', error);
                alert('Network error loading student');
            }
        };
        
        // Back button
        document.getElementById('backToFamilyBtn').addEventListener('click', () => {
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('familyPassword').value = '';
            document.getElementById('message').style.display = 'none';
            document.getElementById('familySubmitBtn').disabled = false;
            document.getElementById('familySubmitBtn').textContent = 'Continue ‚Üí';
        });
        
        // Create Family Account button
        document.getElementById('createFamilyBtn').addEventListener('click', async () => {
            const familyName = document.getElementById('familyName').value.trim();
            const familyPassword = document.getElementById('familyPassword').value.trim();
            const message = document.getElementById('message');
            
            if (!familyName || !familyPassword) {
                message.textContent = 'Please enter both family name and password to create an account';
                message.className = 'message error';
                message.style.display = 'block';
                return;
            }
            
            const createBtn = document.getElementById('createFamilyBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                const response = await fetch(`${API_URL}/family/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        family_name: familyName, 
                        password: familyPassword 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    message.textContent = `Family "${familyName}" created! Now logging in...`;
                    message.className = 'message success';
                    message.style.display = 'block';
                    
                    // Auto-login after creation
                    setTimeout(() => {
                        document.getElementById('familyLoginForm').dispatchEvent(new Event('submit'));
                    }, 1500);
                } else {
                    message.textContent = data.error || 'Failed to create family account';
                    message.className = 'message error';
                    message.style.display = 'block';
                    
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create New Family Account';
                }
            } catch (error) {
                console.error('Create family error:', error);
                message.textContent = 'Network error. Please try again.';
                message.className = 'message error';
                message.style.display = 'block';
                
                createBtn.disabled = false;
                createBtn.textContent = 'Create New Family Account';
            }
        });
    </script>
</body>
</html>
